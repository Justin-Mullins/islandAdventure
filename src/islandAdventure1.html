<!doctype html>
<head>
  <title> Island Adventure 1</title>
  <meta charset="UTF-8">
  <script src="jquery-3.3.1.js"></script>
  <link rel="stylesheet" href="popup.css">
</head>
<div id="header"></div>

<div class="popup_box">    <!-- PopupBox div-->
  <h1>Test</h1>
  <p></p>
  <a id="popupBoxClose">x</a>
  <button id="newGameButton" class="button">Play Again</button>
</div>

<div>
  <div id="console">
    <div class="item" id="topMenu">
      <div id="output2">
        <p class="resource" id="food"></p>
        <p class="resource" id="gold"></p>
        <p class="resource" id="experience"></p>
      </div>
    </div>
    <div id="container">
      <div class="item" id="stage"></div>
      <div class="item" id="menu">
        <p id="title"></p>
        <p id="output"></p>
        <div id="tab1">
          <p id="tabText1">B u y</p>
        </div>
      </div>
      <div id="tab2" class="tab">
        <p id="tabText2">I<br>t<br>e<br>m<br>s</p>
      </div>
      <div id="tab3" class="tab">
        <p id="tabText3">S e l l</p>
      </div>
    </div>
  </div>
</div>

<script>

// <--- jQuery for the popup window --->

$(document).ready( function() {

   // When site loaded, load the Popupbox First
   // loadPopupBox();

   $('#popupBoxClose').click( function() {
     unloadPopupBox();
   });

   function unloadPopupBox() {    // TO Unload the Popupbox
     $(".popup_box").fadeOut("fast");
     $(".modalOverlay").remove();
     window.addEventListener("keydown", keydownHandler, false);
   }

   function loadPopupBox() {    // To Load the Popupbox
     //$("#popupBoxContainer").toggleClass("display");
     $(".popup_box").fadeIn("fast");
     $("body").append('<div class="modalOverlay">');
     window.removeEventListener("keydown", keydownHandler, false);
    }


// <--- End of jQuery for popup window --->
// But jQuery $(document).ready is open for the
// whole javascript document.

  // Get a reference to the stage and output
  var stage = document.querySelector("#stage");
  var output = document.querySelector("#output");
  var foodOutput = document.querySelector("#food");
  var goldOutput = document.querySelector("#gold");
  var experienceOutput = document.querySelector("#experience");
  var title = document.querySelector("#title");

  // Set buttons
  var restartButton = document.querySelector("#newGameButton");
  restartButton.style.cursor = "pointer";
  restartButton.addEventListener("click", newGame, false);

  var buyTab = document.getElementById("tab1");
  buyTab.style.cursor = "pointer";
  buyTab.addEventListener("click", buyMenu, false);

  var sellTab = document.getElementById("tab3");
  sellTab.style.cursor = "pointer";
  sellTab.addEventListener("click", sellMenu, false);

  var itemsTab = document.getElementById("tab2");
  itemsTab.style.cursor = "pointer";
  itemsTab.addEventListener("click", itemMenu, false);

  // The map stores all the non-moving (static) game objects
  var map = [
    [0, 1, 0, 0, 0, 3],
    [0, 0, 0, 1, 0, 0],
    [0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 1, 0],
    [0, 1, 0, 1, 0, 0],
    [0, 0, 0, 0, 0, 0]
  ];

  // Get a count of the total number of islands on this map.
  var numOfIslands = countIslands();

  // The gameObjects array stores all the moving (dynamic) game objects
  var gameObjects = [
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [4, 0, 0, 0, 0, 0]
  ];

  // Map code
  var WATER = 0;
  var ISLAND = 1;
  var PIRATE = 2;
  var HOME = 3;
  var SHIP = 4;

  // the size of each cell
  var SIZE = 64;

  // The number of rows and columns
  var ROWS = map.length;
  var COLUMNS = map[0].length;

  // The key codes for directional keys
  var UP = 38;
  var DOWN = 40;
  var RIGHT = 39;
  var LEFT = 37;

  // The Ship's row and column
  var shipRow;
  var shipColumn;

  // The player's resouces Variables
  var gold = 100;
  var food = 12;
  var experience = 0;
  var gameMessage = "Use the arrow keys to find your way home.";

  // Arrays for each resource, to store 3 values each.
  // 1. player's total of that resource,
  // 2. resource name to be displayed as string.
  // 3. The upper and lower bound price of each resource.
  var tradeItem1 = [0, "coffee", 20];
  var tradeItem2 = [0, "coal" , 10];
  var tradeItem3 = [0, "grain", 10];
  var tradeItem4 = [0, "sugar", 15];
  var tradeItem5 = [0, "salt", 30];
  var tradeItem6 = [0, "wool", 40];
  var tradeItem7 = [0, "cotton", 55];
  var tradeItem8 = [0, "iron ore", 80];
  var tradeItem9 = [0, "tin ore", 50];
  var tradeItem10 = [0, "wine", 45];

  // Array with all the trade items in it.
  var TRADEITEMS = [tradeItem1, tradeItem2, tradeItem3, tradeItem4, tradeItem5,
                    tradeItem6, tradeItem7, tradeItem8, tradeItem9, tradeItem10];

  // This array stores each island's trade resources on the Map
  // As the player travels to a new island, their resources populate here.
  var allIslandsResources = new Array;

  // Initialize the trade items for each island.
  initializeIslandResources();

  // display initial starting values
  foodOutput.innerHTML = "Food :  " + food;
  goldOutput.innerHTML = "Gold :  " + gold;
  experienceOutput.innerHTML = "Cargo Room:  " + experience + " / 20";

  // The keyboard listener to trigger keydownHandler function if a key is pressed
  window.addEventListener("keydown", keydownHandler, false);

  render();

  // This function detects which key was pressed and how to update ship position
  function keydownHandler(event) {
    // Stores the key code for the key just pressed
    var key = event.keyCode;
    //console.log("key code: " + key);

    // Clear any existing output text
    if (key === UP || key === DOWN || key === LEFT || key === RIGHT) {
      output.innerHTML = "";
    }

    // Decides which key was pressed and how to move the ship
    switch (key) {
      case UP:
        // If the ship is not at the top edge of the map
        if (shipRow > 0) {
          // move the ship up one space.
          shipRow--;
          food--; // Use up a food at the end of each turn
        }
        break;
      case DOWN:
        // If the ship is not at the bottom edge of the map
        if (shipRow < ROWS - 1) {
          // move the ship down one space.
          shipRow++;
          food--; // Use up a food at the end of each turn
        }
        break;
      case LEFT:
        // If the ship is not at the left edge of the map
        if (shipColumn > 0) {
          // move the ship left one space.
          shipColumn--;
          food--; // Use up a food at the end of each turn
        }
        break;
      case RIGHT:
        // If the ship is not at the right edge of the map
        if (shipColumn < COLUMNS - 1) {
          // move the ship right one space.
          shipColumn++;
          food--; // Use up a food at the end of each turn
        }
        break;
    }

    // Only excecute the next actions if the key pressed was up, down, left or right
    if (key === UP || key === DOWN || key === LEFT || key === RIGHT) {
      resetGameObjects(); // Update the gameObjects array
      shipLocationAction(); // Find ship location and perform action
      // Update resource count being displayed
      //output.innerHTML = "";
      foodOutput.innerHTML = "Food: " + food;
      goldOutput.innerHTML = "Gold: " + gold;
      experienceOutput.innerHTML = "Experience: " + experience;
      if (food <= 0 /* || gold <= 0 */) { endGame(); } // Check for endGame conditions
      render();
    }
  }

  function resetGameObjects() {
    // Update the gameObjects array
    for (var row = 0; row < ROWS; row++) {
      for (var column = 0; column < COLUMNS; column++) {
        if (shipRow === row && shipColumn === column) {
          gameObjects[row][column] = 4;
        }
        else {
          gameObjects[row][column] = 0;
        }
      }
    }
  }

  function countIslands() {
    var numIslands = 0;
    // Loop through all the spaces on the map and count the num of islands.
    for (var row = 0; row < map.length; row++) {
      for (var column = 0; column < map[row].length; column++) {
        if (map[row][column] === 1) {
          numIslands++;
        }
      }
    }
    return numIslands;
  }

  function currentIslandNumber() {
    var islandIndex = 0;
    // Loop through the map and check which island you are currently on.
    // Island count starts at 0 from the top left corner of the map.
    for (var row = 0; row < ROWS; row++) {
      for (var column = 0; column < COLUMNS; column++) {
        // As each island is found onf the map, increment the index.
        if (map[row][column] === 1) {
          islandIndex++;
          // When the island is found that the ship is on, return the number.
          if (gameObjects[row][column] === 4) {
            return islandIndex;
          }
        }
      }
    }
  }

  function initializeIslandResources() {
    for (var i = 0; i < countIslands(); i++) {
      // I need to make a temporary copy of TRADEITEMS array that will
      // not change the original array, because I will be removing items
      // from the copy. To make a copy that won't change the original-
      // I have to use the .slice(0) to return a copy of the whole array.
      var tradeItemsCopy = TRADEITEMS.slice(0);
      // Create an empty array to hold the items that will be bought and sold
      // on each island.
      var islandTempResources = [];
      // Create an empty variable that will hold the item index.
      var randItemIndex;
      for (var j = 0; j < 8; j++) {
        // Create a random item index to pull an item from the array.
        randItemIndex = Math.floor(Math.random() * tradeItemsCopy.length);
        // Remove the random item from the tradeItemsCopy array,
        // and then add it to the islandTempResources array for this island.
        var temp = tradeItemsCopy.splice(randItemIndex, 1);
        islandTempResources.push(temp[0]);
      }
      // Add this island's trading resources to the all island resource array.
      allIslandsResources.push(islandTempResources);
    }
    // console.log(allIslandsResources);
  }

  // This finds what kind of tile the ship is on top of
  // Currently and then performs action for that location.
  function shipLocationAction() {
    var currentLocation = map[shipRow][shipColumn];
    switch (currentLocation) {
      case WATER:
        title.innerHTML = "You sail the open sea.";
        break;
      case ISLAND:
        var randChoice = Math.floor((Math.random() * 2) + 1);
        switch (randChoice) {
          case 1:
            buyMenu();
            break;
          case 2:
            fight();
            break;
          case 3:
            randEncounter();
            break;
        }
        break;
      case PIRATE:
        fight();
        break;
      case HOME:
        endGame();
        break;
      }
  }

  function buyMenu() {
    var quantityToBuy = new Array;
    // Create an array to hold the items that will be bought and sold
    // on this island.
    var islandTempResources = allIslandsResources[currentIslandNumber()];
    //console.log(islandTempResources);

    // Display the trading text
    title.innerHTML = "You find a trading outpost.";
    output.innerHTML = "<p id='tradeMessage'>You can buy:</p><div style='margin-top: 10px'>";

    // This for loop will go through each of the item resources for buying
    // It has the .length / 2 because the second half of the list is for selling.
    for (var index = 0; index < islandTempResources.length / 2; index++) {
      var resourcePrice = islandTempResources[index][2];
      var resourceName = islandTempResources[index][1];
      // Current id for the buy quantity field.
      var buyFieldId = "buyField" + index;
      // var buyButtonId = "buyButton" + index;
      // Get the max quantity of this item the player can purchase.
      var max = gold / resourcePrice;
      // Add the output for displaying the resource name.
      output.innerHTML += "<div class='row'>";
      output.innerHTML += resourceName;
      // Add the output displaying the resource's cost.
      output.innerHTML += ": " + resourcePrice;
      // Make a form so the player can select the ammount they want to purchase.
      // output.innerHTML += "<form>";
      output.innerHTML += "<input type='number' class='buyInput' id='temp' name='quantity' value='0' min='0' max='5' SIZE='3'>";
      // output.innerHTML += "<input type='button' id='buy' class='button' value='Buy'>";
      output.innerHTML += "</div>";

      // Change some of the attributes and id names to be unique, since this is
      // looped in the for loop, each field needs a unique id.
      document.getElementById("temp").setAttribute("max", max);
      document.getElementById("temp").setAttribute("id", buyFieldId);
      // document.getElementById("buy").setAttribute("id", buyButtonId);
    }

    // Add the button to the bottom, of the trade menu
    output.innerHTML += "</div><br><input type='button' id='buyButton' class='button' value='Buy'>";
    // output.innerHTML += "</div>";
    // Add Event listener for clicks on the buy button.

    var buyButton = document.querySelector("#buyButton");
    buyButton.style.cursor = "pointer";
    buyButton.addEventListener("click", buyResources, false);
  }

  // This function is called after the buy button is pressed.
  function buyResources() {
    var currentIslandResources = allIslandsResources[currentIslandNumber()].slice(0);
    // 1. First thing is to test the inputs and make sure they are whole numbers
    // and are not negative
    for (var h = 0; h < currentIslandResources.length / 2; h++) {
      // round down to make sure no decimals are input.
      document.getElementById("buyField" + h).value = Math.floor(document.getElementById("buyField" + h).value);
      var quant = Math.floor(document.getElementById("buyField" + h).value);
      if (quant < 0) {
        alert("No negative numbers!");
        buyMenu();
      }
    }

    // 2. Second thing is to determine if the player has enough gold to buy
    // the selected resources.
    var totalCost = 0;
    var inputs = [];
    // Loop through the items for sale and add up the quantity
    // that the player wants to buy.
    for (var i = 0; i < currentIslandResources.length / 2; i++) {
      var resourcePrice = currentIslandResources[i][2];
      var resourceName = currentIslandResources[i][1];

      // Get the quantity that the player input from the input fields.
      var quantity = document.getElementById("buyField" + i).value;
      totalCost += resourcePrice * quantity;
    }
    // If player does not have enough gold, display message
    if (totalCost > gold) {
      title.innerHTML = "You do not have enough gold.";
      title.style.color = "red";
    }
    else {

      // Loop through each resource for sale on the island,
      // and add each quantity selected to the player's resouces.
      for (var j = 0; j < currentIslandResources.length / 2; j++) {
        var name = currentIslandResources[j][1];
        // Loop through the TRADEITEMS array (where the player's resources
        // are stored).
        for (var k = 0; k < TRADEITEMS.length; k++) {
          if (name === TRADEITEMS[k][1]) {
            // add the purchased item quantity to player's resources.
            TRADEITEMS[k][0] = Number(TRADEITEMS[k][0]) + Number(document.getElementById("buyField" + j).value);
          }
        }
      }
      console.log("all resources after: " + TRADEITEMS);

      // Reset the buy quantities to 0 of the island's resources.
      for (var m = 0; m < currentIslandResources.length / 2; m++) {
        document.getElementById("buyField" + m).value = 0;
      }

      // remove the totalCost from the player's gold.
      gold -= totalCost;
      goldOutput.innerHTML = "Gold: " + gold;
    }
  }

  function sellMenu() {

  }

  function itemMenu() {
    
  }

  function fight() {
    console.log("fight");
    title.innerHTML = "Pirate Attack!";
  }

  function randEncounter() {
    console.log("randEncounter");
  }

  function endGame() {
    console.log("endGame");
    loadPopupBox();
    if (food <= 0) {
      $(".popup_box h1").html("Game Over");
      $(".popup_box p").html("You ran out of food.");
    }
  }

  function newGame() {

  }

  function render() {
    // Clear the stage of img tag cells
    // from the previous background
    if (stage.hasChildNodes()) {
      for (var i = 0; i < ROWS * COLUMNS; i++) {
        stage.removeChild(stage.firstChild);
      }
    }

    // Render the game by looping through the map arrays
    for(var row = 0; row < ROWS; row++) {
      for(var column = 0; column < COLUMNS; column++) {

        // Create an img tag called cell
        var cell = document.createElement("img");

        // Set its CSS class to "cell"
        cell.setAttribute("class", "cell");

        // Add the img tag to the <div id="stage"> tag
        stage.appendChild(cell);


        // if the ship is here, update the ship's row and column
        if (gameObjects[row][column] === SHIP) {
          shipRow = row;
          shipColumn = column;
        }

        // Find the correct image for this map cell
        switch (map[row][column]) {
          case WATER:
            cell.src = "../images/water.png";
            break;
          case ISLAND:
            cell.src = "../images/island.png";
            break;
          case PIRATE:
            cell.src = "../images/pirate.png";
            break;
          case HOME:
            cell.src = "../images/home.png";
            break;
          }

          // Add the ship from the gameObjects array
          switch (gameObjects[row][column]) {
            case SHIP:
              cell.src = "../images/ship.png";
              break;
            default:

          }

        // Position the cell
        cell.style.top = row * SIZE + "px";
        cell.style.left = column * SIZE + "px";
      }
    }
  }
// <--- This is where the jQuery ends here --->
});
</script>
