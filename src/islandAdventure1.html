<!doctype html>
<head>
<title> Island Adventure 1</title>
<script src="jquery-3.3.1.js"></script>
<link rel="stylesheet" href="popup.css">
</head>
<div id="header"></div>

<div class="popup_box">    <!-- PopupBox div-->
  <h1>Test</h1>
  <a id="popupBoxClose">x</a>
  <button class="button">Trade</button>
</div>

<div>
  <div id="console">
    <div class="item" id="topMenu">
      <div id="output2">
        <p class="resource" id="food"></p>
        <p class="resource" id="gold"></p>
        <p class="resource" id="experience"></p>
      </div>
    </div>
    <div id="container">
      <div class="item" id="stage"></div>
      <div class="item" id="menu">
        <p id="title"></p>
        <p id="output"></p>
      </div>
    </div>
  </div>
</div>

<script>

// <--- jQuery for the popup window --->

$(document).ready( function() {

   // When site loaded, load the Popupbox First
   // loadPopupBox();

   $('#popupBoxClose').click( function() {
     unloadPopupBox();
   });

   function unloadPopupBox() {    // TO Unload the Popupbox
     $(".popup_box").fadeOut("fast");
     $(".modalOverlay").remove();
     window.addEventListener("keydown", keydownHandler, false);
   }

   function loadPopupBox() {    // To Load the Popupbox
     //$("#popupBoxContainer").toggleClass("display");
     $(".popup_box").fadeIn("fast");
     $("body").append('<div class="modalOverlay">');
     window.removeEventListener("keydown", keydownHandler, false);
    }


// <--- End of jQuery for popup window --->
// But jQuery $(document).ready is open for the
// whole javascript document.

  // Get a reference to the stage and output
  var stage = document.querySelector("#stage");
  var output = document.querySelector("#output");
  var foodOutput = document.querySelector("#food");
  var goldOutput = document.querySelector("#gold");
  var experienceOutput = document.querySelector("#experience");
  var title = document.querySelector("#title");

  // Set trade and fight buttons
  var button = document.querySelector("button");
  button.style.cursor = "pointer";
  button.addEventListener("click", trade, false);

  // The map stores all the non-moving (static) game objects
  var map = [
    [0, 1, 0, 0, 0, 3],
    [0, 0, 0, 1, 0, 0],
    [0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 1, 0],
    [0, 1, 0, 1, 0, 0],
    [0, 0, 0, 0, 0, 0]
  ];

  // The gameObjects array stores all the moving (dynamic) game objects
  var gameObjects = [
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [4, 0, 0, 0, 0, 0]
  ];

  // Map code
  var WATER = 0;
  var ISLAND = 1;
  var PIRATE = 2;
  var HOME = 3;
  var SHIP = 4;

  // the size of each cell
  var SIZE = 64;

  // The number of rows and columns
  var ROWS = map.length;
  var COLUMNS = map[0].length;

  // The key codes for directional keys
  var UP = 38;
  var DOWN = 40;
  var RIGHT = 39;
  var LEFT = 37;

  // The Ship's row and column
  var shipRow;
  var shipColumn;

  // The player's resouces Variables
  var gold = 10;
  var food = 10;
  var coffee = 0;
  var sugar = 0;
  var spices = 0;
  var silk = 0;
  var experience = 0;
  var gameMessage = "Use the arrow keys to find your way home.";

  // display initial starting values
  foodOutput.innerHTML = "Food: " + food;
  goldOutput.innerHTML = "Gold: " + gold;
  experienceOutput.innerHTML = "Experience: " + experience;

  // The keyboard listener to trigger keydownHandler function if a key is pressed
  window.addEventListener("keydown", keydownHandler, false);

  render();

  // This function detects which key was pressed and how to update ship position
  function keydownHandler(event) {
    // Clear any existing output text
    output.innerHTML = "";
    // Stores the key code for the key just pressed
    var key = event.keyCode;
    //console.log("key code: " + key);

    // Decides which key was pressed and how to move the ship
    switch (key) {
      case UP:
        // If the ship is not at the top edge of the map
        if (shipRow > 0) {
          // move the ship up one space.
          shipRow--;
        }
        break;
      case DOWN:
        // If the ship is not at the bottom edge of the map
        if (shipRow < ROWS - 1) {
          // move the ship down one space.
          shipRow++;
        }
        break;
      case LEFT:
        // If the ship is not at the left edge of the map
        if (shipColumn > 0) {
          // move the ship left one space.
          shipColumn--;
        }
        break;
      case RIGHT:
        // If the ship is not at the right edge of the map
        if (shipColumn < COLUMNS - 1) {
          // move the ship right one space.
          shipColumn++;
        }
        break;
    }

    // Only excecute the next actions if the key pressed was up, down, left or right
    if (key === UP || key === DOWN || key === LEFT || key === RIGHT) {
      food--; // Use up a food at the end of each turn
      shipLocationAction(); // Find ship location and perform action
      resetGameObjects(); // Update the gameObjects array
      // Update resource count being displayed
      foodOutput.innerHTML = "Food: " + food;
      goldOutput.innerHTML = "Gold: " + gold;
      experienceOutput.innerHTML = "Experience: " + experience;
      if (food <= 0 || gold <= 0) { endGame(); } // Check for endGame conditions
      render();
    }
  }

  function resetGameObjects() {
    // Update the gameObjects array
    for (var row = 0; row < ROWS; row++) {
      for (var column = 0; column < COLUMNS; column++) {
        if (shipRow === row && shipColumn === column) {
          gameObjects[row][column] = 4;
        }
        else {
          gameObjects[row][column] = 0;
        }
      }
    }
  }

  // This finds what kind of tile the ship is on top of
  // Currently and then performs action for that location.
  function shipLocationAction() {
    var currentLocation = map[shipRow][shipColumn];
    switch (currentLocation) {
      case WATER:
        title.innerHTML = "You sail the open sea.";
        break;
      case ISLAND:
        var randChoice = Math.floor((Math.random() * 2) + 1);
        switch (randChoice) {
          case 1:
            trade();
            break;
          case 2:
            fight();
            break;
          case 3:
            randEncounter();
            break;
        }
        break;
      case PIRATE:
        fight();
        break;
      case HOME:
        endGame();
        break;
      }
  }

  function trade() {
    // $("#popup_box").append('<p class="message">');
    console.log("trade");
    title.innerHTML = "Trading Outpost";
  }

  function fight() {
    console.log("fight");
    title.innerHTML = "Pirate Attack!";
  }

  function randEncounter() {
    console.log("randEncounter");
  }

  function endGame() {
    console.log("endGame");
  }

  function render() {
    // Clear the stage of img tag cells
    // from the previous background

    if (stage.hasChildNodes()) {
      for (var i = 0; i < ROWS * COLUMNS; i++) {
        stage.removeChild(stage.firstChild);
      }
    }

    // Render the game by looping through the map arrays
    for(var row = 0; row < ROWS; row++) {
      for(var column = 0; column < COLUMNS; column++) {

        // Create an img tag called cell
        var cell = document.createElement("img");

        // Set its CSS class to "cell"
        cell.setAttribute("class", "cell");

        // Add the img tag to the <div id="stage"> tag
        stage.appendChild(cell);


        // if the ship is here, update the ship's row and column
        if (gameObjects[row][column] === SHIP) {
          shipRow = row;
          shipColumn = column;
        }

        // Find the correct image for this map cell
        switch (map[row][column]) {
          case WATER:
            cell.src = "../images/water.png";
            break;
          case ISLAND:
            cell.src = "../images/island.png";
            break;
          case PIRATE:
            cell.src = "../images/pirate.png";
            break;
          case HOME:
            cell.src = "../images/home.png";
            break;
          }

          // Add the ship from the gameObjects array
          switch (gameObjects[row][column]) {
            case SHIP:
              cell.src = "../images/ship.png";
              break;
            default:

          }

        // Position the cell
        cell.style.top = row * SIZE + "px";
        cell.style.left = column * SIZE + "px";
      }
    }
  }
// <--- This is where the jQuery ends here --->
});
</script>
