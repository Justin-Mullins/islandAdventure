<!doctype html>
<head>
<title> Island Adventure 1</title>
<script src="jquery-3.3.1.js"></script>
<link rel="stylesheet" href="popup.css">
</head>
<div class="popup_box" id="tradeMenu">    <!-- PopupBox div-->
  <h1>Trade</h1>
  <a id="popupBoxClose" id="fightMenu">x</a>
  <button class="button" id="tradeButton">Trade</button>
</div>
<div class="popup_box">    <!-- PopupBox div-->
  <h1>Fight</h1>
  <a id="popupBoxClose">x</a>
  <button class="button" id="fightButton">Fight</button>
</div>
</div>
<div id="stage"></div>
<p id="output"></p>

<script>

// <--- jQuery for the popup window --->

$(document).ready( function() {

   // When site loaded, load the Popupbox First
   // loadPopupBox();

   $('#popupBoxClose').click( function() {
     unloadPopupBox();
   });

   function unloadPopupBox(input) {    // TO Unload the Popupbox
     $(input).fadeOut("fast");
     $(".modalOverlay").remove();
     window.addEventListener("keydown", keydownHandler, false);
   }

   function loadPopupBox(input) {    // To Load the Popupbox
     //$("#popupBoxContainer").toggleClass("display");
     $(input).fadeIn("fast");
     $("body").append('<div class="modalOverlay">');
     window.removeEventListener("keydown", keydownHandler, false);
    }


// <--- End of jQuery for popup window --->
// But jQuery $(document).ready is open for the
// whole javascript document.

// Get a reference to the stage and output
  var stage = document.querySelector("#stage");
  var output = document.querySelector("#output");

  // The map stores all the non-moving (static) game objects
  var map = [
    [0, 1, 0, 0, 0, 3],
    [0, 0, 0, 1, 0, 0],
    [0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 1, 0],
    [0, 1, 0, 1, 0, 0],
    [0, 0, 0, 0, 0, 0]
  ];

  // The gameObjects array stores all the moving (dynamic) game objects
  var gameObjects = [
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0],
    [4, 0, 0, 0, 0, 0]
  ];

  // Map code
  var WATER = 0;
  var ISLAND = 1;
  var PIRATE = 2;
  var HOME = 3;
  var SHIP = 4;

  // the size of each cell
  var SIZE = 64;

  // The number of rows and columns
  var ROWS = map.length;
  var COLUMNS = map[0].length;

  // The key codes for directional keys
  var UP = 38;
  var DOWN = 40;
  var RIGHT = 39;
  var LEFT = 37;

  // The Ship's row and column
  var shipRow;
  var shipColumn;

  // The player's resouces Variables
  var gold = 10;
  var food = 10;
  var experience = 0;
  var gameMessage = "Use the arrow keys to find your way home.";

  // The keyboard listener to trigger keydownHandler function if a key is pressed
  window.addEventListener("keydown", keydownHandler, false);

  render();

  // This function detects which key was pressed and how to update ship position
  function keydownHandler(event) {
    // Clear any existing output text
    output.innerHTML = "";
    // Stores the key code for the key just pressed
    var key = event.keyCode;
    //console.log("key code: " + key);

    // Decides which key was pressed and how to move the ship
    switch (key) {
      case UP:
        // If the ship is not at the top edge of the map
        if (shipRow > 0) {
          // move the ship up one space.
          shipRow--;
        }
        break;
      case DOWN:
        // If the ship is not at the bottom edge of the map
        if (shipRow < ROWS - 1) {
          // move the ship down one space.
          shipRow++;
        }
        break;
      case LEFT:
        // If the ship is not at the left edge of the map
        if (shipColumn > 0) {
          // move the ship left one space.
          shipColumn--;
        }
        break;
      case RIGHT:
        // If the ship is not at the right edge of the map
        if (shipColumn < COLUMNS - 1) {
          // move the ship right one space.
          shipColumn++;
        }
        break;
    }

    food--; // Use up a food at the end of each turn
    shipLocationAction(); // Find ship location and perform action
    resetGameObjects(); // Update the gameObjects array
    if (food <= 0 || gold <= 0) { endGame(); }
    render();
  }

  function resetGameObjects() {
    // Update the gameObjects array
    for (var row = 0; row < ROWS; row++) {
      for (var column = 0; column < COLUMNS; column++) {
        if (shipRow === row && shipColumn === column) {
          gameObjects[row][column] = 4;
        }
        else {
          gameObjects[row][column] = 0;
        }
      }
    }
  }

  // This finds what kind of tile the ship is on top of
  // Currently and then performs action for that location.
  function shipLocationAction() {
    var currentLocation = map[shipRow][shipColumn];
    switch (currentLocation) {
      case WATER:
        output.innerHTML = "You sail the open sea.";
        break;
      case ISLAND:
        var randChoice = Math.floor((Math.random() * 2) + 1);
        switch (randChoice) {
          case 1:
            console.log("trade");
            loadPopupBox("#tradeMenu");
            //$("#popup_box").append('<p class="message">');
            //$("p message").html("You have found a trading post.");
            //trade();
            break;
          case 2:
            console.log("fight");
            //fight();
            break;
          case 3:
            randEncounter();
            break;
        }
        break;
      case PIRATE:
        fight();
        break;
      case HOME:
        endGame();
        break;
      }
  }

  function trade() {
    // $("#popup_box").append('<p class="message">');
    $("p message").html("");
    $("button tradeButton").hide();
    $("#popup_box h1").html("Trading Outpost");
  }

  function fight() {
    console.log("fight");
  }

  function randEncounter() {
    console.log("randEncounter");
  }

  function endGame() {
    console.log("endGame");
  }

  function render() {
    // Clear the stage of img tag cells
    // from the previous background

    if (stage.hasChildNodes()) {
      for (var i = 0; i < ROWS * COLUMNS; i++) {
        stage.removeChild(stage.firstChild);
      }
    }

    // Render the game by looping through the map arrays
    for(var row = 0; row < ROWS; row++) {
      for(var column = 0; column < COLUMNS; column++) {

        // Create an img tag called cell
        var cell = document.createElement("img");

        // Set its CSS class to "cell"
        cell.setAttribute("class", "cell");

        // Add the img tag to the <div id="stage"> tag
        stage.appendChild(cell);


        // if the ship is here, update the ship's row and column
        if (gameObjects[row][column] === SHIP) {
          shipRow = row;
          shipColumn = column;
        }

        // Find the correct image for this map cell
        switch (map[row][column]) {
          case WATER:
            cell.src = "../images/water.png";
            break;
          case ISLAND:
            cell.src = "../images/island.png";
            break;
          case PIRATE:
            cell.src = "../images/pirate.png";
            break;
          case HOME:
            cell.src = "../images/home.png";
            break;
          }

          // Add the ship from the gameObjects array
          switch (gameObjects[row][column]) {
            case SHIP:
              cell.src = "../images/ship.png";
              break;
            default:

          }

        // Position the cell
        cell.style.top = row * SIZE + "px";
        cell.style.left = column * SIZE + "px";
      }
    }
  }
// <--- This is where the jQuery ends here --->
});
</script>
